---
 - hosts: localhost
   vars:
    - registry_name: 
    - workspace: /home/docker/
    - username: 
    - password:  #vault
    - image_name: javaimage:v4
    - email: 
   tasks:
   - name: set random variable
     set_fact:
      random_name : ['test0','test1', 'test2']
   - name: Login docker registry
     docker_login:
       registry: "{{ registry_name }}.azurecr.io"
       username: "{{ registry_name }}"
       password: "{{ password }}"
   - name: Docker Build and Push
     docker_image:
       name: "{{ registry_name }}.azurecr.io/{{ image_name }}"
       source: build
       build:
        path: "{{ workspace }}"
       push: yes
   - name: Create a container
     docker_container:
      name: javaimage-container-{{ item }}
      image: "{{ registry_name }}.azurecr.io/{{ image_name }}"
      detach: true
      state: started
      volumes:
        - /var/run/docker.sock:/var/run/docker.sock
      env:
          AZP_URL: 
          AZP_TOKEN: tdhqmnx7qef3vajiuvfkaodzl35365nysau5hqa2zbzvskdtrl6q
          AZP_AGENT_NAME: azure-agent-{{ item }}
          AZP_POOL: -DevSecOps-UT
     with_items: 
      - "{{ random_name }}"
     register: output
   - debug:
      msg: "{{output}}"
    